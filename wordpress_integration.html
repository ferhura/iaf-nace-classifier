<!-- 
GUÍA DE INTEGRACIÓN PARA WORDPRESS (DISEÑO PREMIUM)

1. Copia este código.
2. En tu página de WordPress, añade un bloque de "HTML Personalizado" (Custom HTML) o "Code Block" (Avada).
3. Pega el código.
4. IMPORTANTE: La variable 'API_URL' ya está configurada para producción.
-->

<style>
    /* Estilos encapsulados con prefijo #iaf-widget para no romper tu tema */
    #iaf-widget {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        max-width: 800px;
        margin: 2rem auto;
        color: #1e293b;
        line-height: 1.5;
    }

    #iaf-widget * {
        box-sizing: border-box;
    }

    /* Search Container */
    #iaf-widget .search-container {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        border: 1px solid rgba(255, 255, 255, 0.5);
        margin-bottom: 2rem;
    }

    #iaf-widget .input-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    #iaf-widget label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1e293b;
        margin-left: 0.25rem;
    }

    /* Main Search Box */
    #iaf-widget .search-box-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        transition: all 0.2s ease;
        background: #f8fafc;
    }

    #iaf-widget .search-box-wrapper:focus-within {
        border-color: #2563eb;
        background: white;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    #iaf-widget .search-icon {
        width: 20px;
        height: 20px;
        color: #64748b;
        margin-left: 1rem;
        flex-shrink: 0;
    }

    #iaf-widget input[type="text"] {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        border: none;
        background: transparent;
        outline: none;
        color: #1e293b;
        font-family: inherit;
    }

    /* Advanced Inputs */
    #iaf-widget .secondary-input {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
        transition: all 0.2s ease;
        color: #1e293b;
    }

    #iaf-widget .secondary-input:focus {
        border-color: #2563eb;
        background: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    #iaf-widget .advanced-inputs {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        padding-top: 1rem;
        border-top: 1px dashed #e2e8f0;
        animation: iafSlideDown 0.3s ease-out;
    }

    #iaf-widget .hidden {
        display: none !important;
    }

    @keyframes iafSlideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #iaf-widget .toggle-btn {
        background: none;
        border: none;
        color: #2563eb;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        padding: 0.5rem;
        display: block;
        margin: 0 auto;
        transition: color 0.2s;
    }

    #iaf-widget .toggle-btn:hover {
        color: #1d4ed8;
        text-decoration: underline;
    }

    /* Results */
    #iaf-widget .results-grid {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    #iaf-widget .result-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        transition: all 0.2s ease;
        animation: iafFadeIn 0.4s ease-out;
    }

    @keyframes iafFadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #iaf-widget .result-card:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        transform: translateY(-2px);
    }

    #iaf-widget .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    #iaf-widget .nace-code {
        font-family: 'Monaco', 'Consolas', monospace;
        font-weight: 700;
        color: #2563eb;
        background: #eff6ff;
        padding: 0.25rem 0.75rem;
        border-radius: 8px;
        font-size: 1.1rem;
    }

    #iaf-widget .relevance-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    #iaf-widget .relevance-badge.high {
        background-color: #dcfce7;
        color: #166534;
    }

    #iaf-widget .relevance-badge.medium {
        background-color: #fef9c3;
        color: #854d0e;
    }

    #iaf-widget .relevance-badge.low {
        background-color: #f1f5f9;
        color: #64748b;
    }

    #iaf-widget .nace-description {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 1rem;
        line-height: 1.4;
    }

    #iaf-widget .exclusion-note {
        margin-top: 0.75rem;
        margin-bottom: 0.75rem;
        font-size: 0.85rem;
        color: #b45309;
        background: #fffbeb;
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid #fcd34d;
        line-height: 1.4;
    }

    #iaf-widget .iaf-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
        color: #64748b;
        font-size: 0.95rem;
    }

    #iaf-widget .iaf-value {
        font-weight: 600;
        color: #2563eb;
    }

    #iaf-widget .risks-container {
        margin-top: 1.25rem;
        background: #fff1f2;
        border: 1px solid #fecdd3;
        border-radius: 12px;
        padding: 1rem;
    }

    #iaf-widget .risks-container h4 {
        font-size: 0.9rem;
        font-weight: 700;
        color: #9f1239;
        margin-bottom: 0.5rem;
        margin-top: 0;
    }

    #iaf-widget .risks-container ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    #iaf-widget .risks-container li {
        font-size: 0.9rem;
        color: #881337;
        margin-bottom: 0.25rem;
        padding-left: 1rem;
        position: relative;
    }

    #iaf-widget .risks-container li::before {
        content: "•";
        position: absolute;
        left: 0;
        color: #be123c;
    }

    #iaf-widget .loading-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e2e8f0;
        border-top-color: #2563eb;
        border-radius: 50%;
        animation: iafSpin 0.8s linear infinite;
        margin: 1rem auto;
        display: none;
    }

    @keyframes iafSpin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<div id="iaf-widget">
    <div class="search-container">
        <div class="input-group">
            <label for="iaf-search-input">Actividad principal</label>
            <div class="search-box-wrapper">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="iaf-search-input"
                    placeholder="Ej. Fabricación de calzado, desarrollo de software..." autocomplete="off">
            </div>
        </div>

        <div id="iaf-advanced-inputs" class="advanced-inputs hidden">
            <div class="input-group">
                <label for="iaf-activities-input">Actividades específicas (Opcional)</label>
                <input type="text" id="iaf-activities-input" class="secondary-input"
                    placeholder="Ej. Corte, cosido, pegado de suelas...">
            </div>
            <div class="input-group">
                <label for="iaf-processes-input">Procesos o tecnologías clave (Opcional)</label>
                <input type="text" id="iaf-processes-input" class="secondary-input"
                    placeholder="Ej. Uso de adhesivos, vulcanizado, agile...">
            </div>
        </div>

        <button id="iaf-toggle-btn" class="toggle-btn">Añadir más detalles</button>
        <div id="iaf-loading" class="loading-spinner"></div>
    </div>

    <div id="iaf-results" class="results-grid"></div>
</div>

<script>
    (function () {
        const API_URL = 'https://iaf-nace-classifier-production.up.railway.app';

        const searchInput = document.getElementById('iaf-search-input');
        const activitiesInput = document.getElementById('iaf-activities-input');
        const processesInput = document.getElementById('iaf-processes-input');
        const resultsContainer = document.getElementById('iaf-results');
        const loadingSpinner = document.getElementById('iaf-loading');
        const toggleBtn = document.getElementById('iaf-toggle-btn');
        const advancedInputs = document.getElementById('iaf-advanced-inputs');

        let debounceTimer;

        // Toggle advanced inputs
        toggleBtn.addEventListener('click', () => {
            advancedInputs.classList.toggle('hidden');
            toggleBtn.textContent = advancedInputs.classList.contains('hidden')
                ? 'Añadir más detalles'
                : 'Ocultar detalles';
        });

        async function performSearch() {
            const query = searchInput.value.trim();
            const activities = activitiesInput.value.trim();
            const processes = processesInput.value.trim();

            if (query.length < 2 && activities.length < 2 && processes.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }

            loadingSpinner.style.display = 'block';
            resultsContainer.innerHTML = '';

            try {
                const response = await fetch(`${API_URL}/classify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        actividades_reales: activities,
                        procesos_criticos: processes
                    })
                });

                const data = await response.json();
                loadingSpinner.style.display = 'none';

                if (data.results && data.results.length > 0) {
                    renderResults(data.results);
                } else {
                    resultsContainer.innerHTML = '<div style="text-align:center; color:#64748b; padding:2rem;">No se encontraron resultados. Intenta con otros términos.</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                loadingSpinner.style.display = 'none';
                resultsContainer.innerHTML = '<div style="text-align:center; color:#dc2626;">Error de conexión con el servidor.</div>';
            }
        }

        function renderResults(results) {
            results.forEach(item => {
                const card = document.createElement('div');
                card.className = 'result-card';

                // Relevancia
                let relevanceClass = 'low';
                if (item.relevancia >= 80) relevanceClass = 'high';
                else if (item.relevancia >= 50) relevanceClass = 'medium';

                // Exclusiones
                let exclusionNote = '';
                if (item.descripcion_completa && item.descripcion_completa.includes('Esta clase no comprende:')) {
                    const parts = item.descripcion_completa.split('Esta clase no comprende:');
                    if (parts.length > 1) {
                        const fullExclusionText = parts[1].trim();
                        const truncatedText = fullExclusionText.substring(0, 200) + (fullExclusionText.length > 200 ? '...' : '');
                        exclusionNote = `<div class="exclusion-note">⚠️ <strong>Nota:</strong> No incluye: ${truncatedText}</div>`;
                    }
                }

                // Riesgos
                let risksHtml = '';
                if (item.riesgos && item.riesgos.length > 0) {
                    risksHtml = `
                        <div class="risks-container">
                            <h4>⚠️ Riesgos clave del sector:</h4>
                            <ul>
                                ${item.riesgos.map(risk => `<li>${risk}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="result-header">
                        <div class="nace-code">${item.codigo_nace}</div>
                        <div class="relevance-badge ${relevanceClass}">${Math.min(100, Math.round(item.relevancia))}% Coincidencia</div>
                    </div>
                    <div class="nace-description">${item.descripcion_nace}</div>
                    ${exclusionNote}
                    <div class="iaf-info">
                        <span class="iaf-label">Sector IAF:</span>
                        <span class="iaf-value">${item.codigo_iaf} - ${item.nombre_iaf}</span>
                    </div>
                    ${risksHtml}
                `;
                resultsContainer.appendChild(card);
            });
        }

        // Event listeners
        [searchInput, activitiesInput, processesInput].forEach(input => {
            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(performSearch, 300);
            });
        });
    })();
</script>